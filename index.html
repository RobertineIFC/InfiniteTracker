<!DOCTYPE html>
<html>
<head>
    <title>Infinite Tracker</title>
    <style>
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .plane-icon {
            width: 32px;
            height: 32px;
            background-image: url('bluearrow.png');
            background-size: cover;
        }

        .atc-icon {
            width: 24px;
            height: 24px;
            background-image: url('atc.png');
            background-size: cover;
        }

        #refresh-button {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #003563;
            color: #fff;
            border-color: #0088ff;
            border-width: 1px;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
        }

        #last-refresh-time {
            position: fixed;
            top: 20px;
            right: 180px;
            color: white;
        }

        .leaflet-popup-content-wrapper {
            background: #fff;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .leaflet-popup-content {
            color: #333;
        }

        .leaflet-popup-close-button {
            position: absolute;
            top: 5px;
            right: 5px;
            color: #999;
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
    <div id="map"></div>
    <button id="refresh-button">Refresh</button>
    <div id="last-refresh-time">Last Refresh: N/A</div>

    <script>
        const apiKey = "16g9z0yzub3dszefdibss5455tytdhkr";
        const sessionId = "df2a8d19-3a54-4ce5-ae65-0b722186e44c";
        const aircraftApiUrl = `https://api.infiniteflight.com/public/v2/sessions/${sessionId}/flights?apikey=${apiKey}`;
        const atcApiUrl = `https://api.infiniteflight.com/public/v2/sessions/${sessionId}/atc?apikey=${apiKey}`;
        const atisApiUrl = `https://api.infiniteflight.com/public/v2/sessions/${sessionId}/airport/{airportIcao}/atis?apikey=${apiKey}`;

        var map = L.map('map', {
            preferCanvas: true,
            layers: [
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                })
            ]
        }).setView([0, 0], 2);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
        }).addTo(map);

        var markerLayer = L.layerGroup().addTo(map);

        function roundToZeroDecimalPlaces(number) {
            return Math.round(number);
        }

        function updateAircraftPositions() {
            const lastRefreshTimeElement = document.getElementById('last-refresh-time');
            const now = new Date();
            const zuluTime = `${now.getUTCHours().toString().padStart(2, '0')}:${now.getUTCMinutes().toString().padStart(2, '0')}`;
            lastRefreshTimeElement.textContent = `Last Refresh: ${zuluTime} ZULU`;

            markerLayer.clearLayers();

            fetch(aircraftApiUrl)
                .then(response => response.json())
                .then(data => {
                    data.result.forEach(aircraft => {
                        const userId = aircraft.userId;
                        const planeIcon = L.divIcon({
                            className: 'plane-icon',
                            iconSize: [32, 32],
                            html: `<div></div>`
                        });

                        const marker = L.marker([aircraft.latitude, aircraft.longitude], { icon: planeIcon });
                        const username = aircraft.username ? aircraft.username : "No username";

                        const flightInfo = `
                            <strong>Username:</strong> ${username}<br>
                            <strong>Callsign:</strong> ${aircraft.callsign}<br>
                            <strong>Altitude:</strong> ${roundToZeroDecimalPlaces(aircraft.altitude)} feet<br>
                            <strong>Speed:</strong> ${roundToZeroDecimalPlaces(aircraft.speed)} knots`;

                        marker.bindPopup(flightInfo, { autoClose: false });
                        markerLayer.addLayer(marker);
                    });

                    fetch(atcApiUrl)
                        .then(response => response.json())
                        .then(atcData => {
                            atcData.result.forEach(atc => {
                                const atcIcon = L.divIcon({
                                    className: 'atc-icon',
                                    iconSize: [24, 24],
                                    html: `<div></div>`
                                });

                                const atcMarker = L.marker([atc.latitude, atc.longitude], { icon: atcIcon });

                                atcMarker.on('click', function () {
                                    fetch(atisApiUrl.replace('{airportIcao}', atc.airportName))
                                        .then(response => response.json())
                                        .then(atisData => {
                                            const atisPopup = `<strong>ATIS at ${atc.airportName}:</strong><br>${atisData.result}`;
                                            atcMarker.bindPopup(atisPopup, { autoClose: false });
                                        })
                                        .catch(error => console.error('Error fetching ATIS data:', error));
                                });

                                markerLayer.addLayer(atcMarker);
                            });
                        })
                        .catch(error => console.error('Error fetching ATC data:', error));
                })
                .catch(error => console.error('Error fetching aircraft data:', error));
        }

        updateAircraftPositions();

        document.getElementById('refresh-button').addEventListener('click', function () {
            updateAircraftPositions();
        });
    </script>
</body>
</html>
